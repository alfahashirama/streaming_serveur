{% extends 'base.html' %}
{% block title %}Stream en direct{% endblock %}
{% block content %}
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Stream en direct</h1>
    </header>
    
    <main>
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
            {% if stats.stream_active %}
                <p class="text-gray-600 dark:text-gray-400">Vous regardez le stream en direct. Spectateurs actuels : {{ stats.viewers }}</p>
                {% if stats.stream_type == 'video' %}
                    <video controls class="w-full max-w-3xl mx-auto">
                        <source src="{{ url_for('static', filename='uploads/' + stats.video_path) }}" type="video/mp4">
                        Votre navigateur ne supporte pas la balise vid√©o.
                    </video>
                {% elif stats.stream_type == 'webcam' %}
                    <img src="{{ url_for('api.stream') }}" alt="Webcam Stream" class="w-full max-w-3xl mx-auto">
                {% endif %}
            {% else %}
                <p class="text-gray-600 dark:text-gray-400">Aucun stream actif pour le moment.</p>
            {% endif %}
        </div>
        {% if stats.stream_active %}
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mt-4">
            <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">Chat en direct</h3>
            <div id="chat-messages" class="h-64 overflow-y-auto mb-4 border p-2 bg-gray-50 dark:bg-gray-700"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500" placeholder="Entrez votre message..." required>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 mt-2">Envoyer</button>
            </form>
        </div>
        {% endif %}
    </main>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        const socket = io();
        socket.on('new_message', (data) => {
            const chat = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'p-2 text-gray-800 dark:text-gray-200';
            messageDiv.textContent = `${data.username}: ${data.message} (${data.created_at.slice(0, 10)})`;
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        });
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            if (input.value.trim()) {
                socket.emit('send_message', { message: input.value });
                input.value = '';
            }
        });
    </script>
{% endblock %}